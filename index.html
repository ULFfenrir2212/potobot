<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Potobot Auditor</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #2e003e;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    #chat {
      border: 4px solid #064d2d;
      border-radius: 16px;
      width: 90%;
      max-width: 600px;
      height: 400px;
      overflow-y: auto;
      padding: 10px;
      margin-bottom: 10px;
      background-color: #3a0057;
    }
    #inputArea {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    input, button {
      padding: 10px;
      font-size: 16px;
      border-radius: 8px;
      border: none;
    }
    #messageInput {
      flex: 1;
    }
    button {
      background-color: #6c00ff;
      color: white;
      cursor: pointer;
    }
    #scanner {
      display: none;
      flex-direction: column;
      align-items: center;
    }
    video {
      width: 100%;
      max-width: 400px;
      border: 4px solid #064d2d;
      border-radius: 12px;
      margin-top: 10px;
    }
    #loading {
      display: none;
      margin-top: 10px;
      font-style: italic;
    }
  </style>
</head>
<body>
  <h1>ü§ñ Potobot - Auditor Inteligente</h1>
  <div id="chat"></div>

  <div id="inputArea">
    <input type="text" id="messageInput" placeholder="Escribe aqu√≠... Ej: Dame la gu√≠a 123456" />
    <button onclick="handleMessage()">üîé Buscar</button>
  </div>

  <input type="file" id="excelInput" accept=".xlsx" />
  <button onclick="openCamera()">üì∑ Escanear gu√≠a</button>
  <button onclick="downloadFaltantes()">‚¨áÔ∏è Descargar faltantes</button>

  <div id="scanner">
    <video id="video" autoplay></video>
    <button onclick="capturePhoto()">üì∏ Tomar Foto</button>
    <canvas id="canvas" style="display:none;"></canvas>
    <div id="loading">‚è≥ Escaneando gu√≠a, por favor espera...</div>
  </div>

  <script>
    let workbookData = [];
    let faltantes = [];

    document.getElementById('excelInput').addEventListener('change', e => {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = evt => {
        const data = new Uint8Array(evt.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        workbookData = XLSX.utils.sheet_to_json(firstSheet);
        appendToChat('üìÅ Archivo cargado con ' + workbookData.length + ' registros.');
      };
      reader.readAsArrayBuffer(file);
    });

    function appendToChat(text) {
      const div = document.createElement('div');
      div.textContent = text;
      document.getElementById('chat').appendChild(div);
      document.getElementById('chat').scrollTop = document.getElementById('chat').scrollHeight;
    }

    function handleMessage() {
      const input = document.getElementById('messageInput').value;
      if (input.includes('Dame la gu√≠a')) {
        const match = input.match(/\d{10,}/);
        if (match) searchGuide(match[0]);
        else appendToChat('‚ùå No se encontr√≥ una gu√≠a v√°lida en tu mensaje.');
      } else {
        appendToChat('ü§ñ Por ahora solo puedo buscar gu√≠as. Intenta: Dame la gu√≠a 1234567890');
      }
      document.getElementById('messageInput').value = '';
    }

    function searchGuide(guia) {
      const resultado = workbookData.find(row => row['Gu√≠a'] == guia);
      if (resultado) {
        let info = `‚úÖ Gu√≠a encontrada: ${guia}\n`;
        for (const campo in resultado) {
          info += `üìå ${campo}: ${resultado[campo]}\n`;
        }
        appendToChat(info);
      } else {
        appendToChat('‚ùå Gu√≠a no encontrada: ' + guia);
        faltantes.push({ Gu√≠a: guia, Fecha: new Date().toLocaleString() });
      }
    }

    function downloadFaltantes() {
      if (faltantes.length === 0) {
        alert('No hay gu√≠as faltantes para descargar.');
        return;
      }
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(faltantes);
      XLSX.utils.book_append_sheet(wb, ws, 'Faltantes');
      XLSX.writeFile(wb, 'faltantes.xlsx');
    }

    // C√°mara y escaneo
    let video = document.getElementById('video');
    let canvas = document.getElementById('canvas');

    async function openCamera() {
      document.getElementById('scanner').style.display = 'flex';
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { exact: "environment" } }
        });
        video.srcObject = stream;
      } catch (err) {
        appendToChat('‚ö†Ô∏è No se pudo acceder a la c√°mara trasera. Usando c√°mara predeterminada...');
        const fallbackStream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = fallbackStream;
      }
    }

    function capturePhoto() {
      document.getElementById('loading').style.display = 'block';
      const ctx = canvas.getContext('2d');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0);

      Tesseract.recognize(canvas, 'eng', { logger: m => console.log(m) })
        .then(({ data: { text } }) => {
          document.getElementById('loading').style.display = 'none';
          const match = text.match(/\d{10,}/);
          if (match) {
            appendToChat('üì∏ Gu√≠a escaneada: ' + match[0]);
            searchGuide(match[0]);
          } else {
            appendToChat('‚ùå No se detect√≥ una gu√≠a v√°lida en la imagen.');
          }
        });
    }
  </script>
</body>
</html>
